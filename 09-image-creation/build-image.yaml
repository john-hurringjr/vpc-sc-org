steps:
- name: gcr.io/cloud-builders/gcloud
  dir: './${_FOLDER}/'
  id: 'create_image_spec'
  entrypoint: "bash"
  args:
  - '-c'
  - |
    cat <<END>packer.json
    {
    "builders": [
      {
        "type": "googlecompute",
        "project_id": "$PROJECT_ID",
        "source_image_family": "ubuntu-minimal-2004-lts",
        "zone": "us-central1-a",
        "instance_name": "testpacker-image-1",
        "ssh_username": "packer",
        "disable_default_service_account": "true",
        "subnetwork": "${_SUBNET}",
        "omit_external_ip": "true",
        "use_internal_ip": "true",
        "use_iap": "true"
      }
      ]
    }
    END
- name: 'gcr.io/$PROJECT_ID/packer'
  dir: './${_FOLDER}/'
  env:
  - 'PROJECT_ID=$PROJECT_ID'
  args:
  - build
  - -var
  - project_id=$PROJECT_ID
  - packer.json